# .github/workflows/release.yml
#
# Builds a signed Flutter APK and uploads it to GitHub Releases
# whenever a tag matching v*.*.* is pushed.
#
# Required repository secrets (Settings → Secrets → Actions):
#   KEYSTORE_BASE64   – base64-encoded release.jks keystore
#   KEY_ALIAS         – alias used when the keystore was created
#   KEY_PASSWORD      – key password
#   STORE_PASSWORD    – keystore password

name: Release APK

on:
    push:
        tags:
            - "v[0-9]+.[0-9]+.[0-9]+" # matches v1.0.0, v2.3.1, etc.

jobs:
    build:
        name: Build & Sign APK
        runs-on: ubuntu-latest

        steps:
            # ── 1. Checkout ──────────────────────────────────────────────────────────
            - name: Checkout repository
              uses: actions/checkout@v4

            # ── 2. Java (required by Gradle) ─────────────────────────────────────────
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"

            # ── 3. Flutter ───────────────────────────────────────────────────────────
            - name: Set up Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.29.0" # pin to your SDK version
                  channel: stable
                  cache: true

            # ── 4. Pub dependencies ──────────────────────────────────────────────────
            - name: Install dependencies
              run: flutter pub get

            # ── 5. Decode keystore from secret ───────────────────────────────────────
            - name: Decode keystore
              run: |
                  echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.jks

            # ── 6. Write key.properties ──────────────────────────────────────────────
            - name: Write key.properties
              run: |
                  cat > android/key.properties <<EOF
                  storePassword=${{ secrets.STORE_PASSWORD }}
                  keyPassword=${{ secrets.KEY_PASSWORD }}
                  keyAlias=${{ secrets.KEY_ALIAS }}
                  storeFile=release.jks
                  EOF

            # ── 7. Derive version from tag (strip leading 'v') ───────────────────────
            - name: Parse version from tag
              id: version
              run: |
                  TAG="${GITHUB_REF_NAME}"          # e.g. v1.2.3
                  NAME="${TAG#v}"                   # e.g. 1.2.3
                  # Build number: count total commits (simple monotonic int)
                  BUILD=$(git rev-list --count HEAD)
                  echo "name=$NAME"   >> "$GITHUB_OUTPUT"
                  echo "build=$BUILD" >> "$GITHUB_OUTPUT"

            # ── 8. Build signed release APK ──────────────────────────────────────────
            - name: Build release APK
              run: |
                  flutter build apk --release \
                    --build-name="${{ steps.version.outputs.name }}" \
                    --build-number="${{ steps.version.outputs.build }}"

            # ── 9. Rename artifact with version ─────────────────────────────────────
            - name: Rename APK
              run: |
                  mv build/app/outputs/flutter-apk/app-release.apk \
                     widget_app-${{ steps.version.outputs.name }}.apk

            # ── 10. Generate SHA-256 checksum (F-Droid & security hygiene) ───────────
            - name: Generate checksum
              run: |
                  sha256sum widget_app-${{ steps.version.outputs.name }}.apk \
                    > widget_app-${{ steps.version.outputs.name }}.apk.sha256

            # ── 11. Upload to GitHub Releases ────────────────────────────────────────
            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  name: "Widget App ${{ steps.version.outputs.name }}"
                  body: |
                      ## What's new
                      <!-- Add release notes here or automate with a CHANGELOG -->

                      ### Install
                      Download `widget_app-${{ steps.version.outputs.name }}.apk` and
                      sideload it, or wait for the F-Droid index to refresh.

                      ### Verify
                      ```
                      sha256sum -c widget_app-${{ steps.version.outputs.name }}.apk.sha256
                      ```
                  files: |
                      widget_app-${{ steps.version.outputs.name }}.apk
                      widget_app-${{ steps.version.outputs.name }}.apk.sha256
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # ── 12. Cleanup – never leave the keystore in the runner ─────────────────
            - name: Remove keystore
              if: always()
              run: |
                  rm -f android/app/release.jks android/key.properties
